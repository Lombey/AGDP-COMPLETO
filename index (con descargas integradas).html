<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AGDP Dashboard | React</title>
    
    <!-- 1. REACT CORE -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. LIBRERIAS EXTERNAS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Flatpickr (Calendario) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBixHiS7Z6kVhh0tN7g9NdZaKrFxSji140" async defer></script>
    
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <!-- 3. FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 4. ESTILOS CSS -->
    <style>
        :root {
            --primary: #204B42; 
            --primary-hover: #163630;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-light: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6; 
            --header-height: 64px;
            --sidebar-width: 180px;
            
            /* Module Specifics */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --input-bg: #ffffff;
            --group-row-bg: #f0fdf4; 
            --group-row-text: #166534; 
            --badge-bg: #e0f2f1;
            --badge-text: #204B42;
            --group-active-bg: var(--surface);
            --group-active-border: var(--success);
            --group-active-text: var(--success);
        }

        body.dark-mode {
            --primary: #2d6a5e;
            --bg-body: #0f172a;       
            --surface: #1e293b;       
            --border: #334155;        
            --text-main: #f1f5f9;     
            --text-light: #94a3b8;    
            --input-bg: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --group-row-bg: #0c2e26; 
            --group-row-text: #a7f3d0;
            --badge-bg: #134e4a;
            --badge-text: #ccfbf1;
            --group-active-bg: #064e3b; 
            --group-active-border: #059669; 
            --group-active-text: #6ee7b7;
        }

        /* Flatpickr Dark Mode Overrides */
        body.dark-mode .flatpickr-calendar { background: var(--surface); box-shadow: var(--shadow-lg); border: 1px solid var(--border); }
        body.dark-mode .flatpickr-day { color: var(--text-main); }
        body.dark-mode .flatpickr-day.selected { background: var(--primary); border-color: var(--primary); }
        body.dark-mode .flatpickr-months .flatpickr-month { color: var(--text-main); fill: var(--text-main); }
        body.dark-mode .flatpickr-weekdays { color: var(--text-light); }
        body.dark-mode span.flatpickr-weekday { color: var(--text-light); }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* HEADER & LAYOUT */
        header { background-color: #204B42; height: var(--header-height); padding: 0 1.5rem; display: flex; justify-content: space-between; align-items: center; color: white; flex-shrink: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .brand { display: flex; align-items: center; gap: 1rem; }
        .brand h1 { font-size: 1.1rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 0.5rem; }
        .logo-box { width:32px; height:32px; background:white; color:#204B42; font-weight:bold; display:flex; align-items:center; justify-content:center; border-radius:4px; font-size: 0.8rem; }
        .version-badge { font-size: 0.7rem; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 4px; font-weight: 400; opacity: 0.9; }
        .header-actions { display: flex; gap: 0.8rem; align-items: center; }
        .user-type-badge { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem; }
        .nav-icon-btn { background: rgba(255,255,255,0.15); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; transition: background 0.2s; }
        .nav-icon-btn:hover { background: rgba(255,255,255,0.25); }
        .notif-dot { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; border: 1px solid #204B42; }
        .user-profile { display: flex; align-items: center; gap: 0.5rem; background: white; color: #204B42; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .main-layout { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); background-color: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding-top: 1rem; transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; flex-shrink: 0; }
        .sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        .sidebar-item { display: flex; gap: 0.8rem; padding: 0.8rem 1.25rem; color: var(--text-light); cursor: pointer; font-size: 0.9rem; align-items: center; text-decoration: none; border-left: 3px solid transparent; transition: all 0.2s; font-weight: 500; }
        .sidebar-item:hover { background: var(--bg-body); color: var(--primary); }
        .sidebar-item.active { color: var(--primary); background: rgba(32, 75, 66, 0.08); border-left-color: var(--primary); }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; }

        /* DOWNLOADS MODULE CSS (Ported Exactly) */
        .module-container { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .dashboard-content { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; overflow-y: auto; height: 100%; }
        
        .kpi-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; flex-shrink: 0; }
        .kpi-card { background: var(--surface); padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; justify-content: center; position: relative; transition: all 0.2s; }
        .kpi-card.clickable-unit:hover { border-color: var(--primary); box-shadow: var(--shadow-md); cursor: pointer; }
        .kpi-header-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.25rem; }
        .kpi-label { font-size: 0.7rem; text-transform: uppercase; font-weight: 600; color: var(--text-light); display: flex; align-items: center; gap: 0.3rem; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }
        .unit-toggle-pill { background-color: var(--badge-bg); color: var(--badge-text); padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .kpi-card.clickable-unit:hover .unit-toggle-pill { background-color: var(--primary); color: white; }

        .controls-container { background-color: var(--surface); padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; flex-direction: column; gap: 0.75rem; z-index: 10; flex-shrink: 0; }
        .filters-row { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        
        .custom-select-wrapper { position: relative; min-width: 130px; flex-grow: 1; }
        /* Ajuste: aseguramos que los inputs/selects tengan 36px de alto consistente */
        .custom-select-trigger, .search-input, .date-input, .btn-std, .btn-group, .btn-group-item { height: 36px; display: flex; align-items: center; box-sizing: border-box; font-family: 'Inter', sans-serif; font-size: 0.85rem; border-radius: 0.375rem; }
        
        .btn-std { justify-content: center; gap: 0.5rem; padding: 0 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s; white-space: nowrap; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-outline { background-color: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: var(--text-light); }
        .btn-flash { color: var(--text-main); border: 1px solid var(--border); background: var(--surface); width: 180px; justify-content: center; }
        .btn-flash.active { color: white; border: 1px solid var(--primary); background: var(--primary); }
        .btn-square { width: 36px; min-width: 36px; padding: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .custom-select-trigger { justify-content: space-between; padding: 0 0.75rem; background: var(--input-bg); border: 1px solid var(--border); cursor: pointer; color: var(--text-light); white-space: nowrap; overflow: hidden; user-select: none; }
        .custom-select-trigger:hover { border-color: var(--primary); color: var(--text-main); }
        .group-by-wrapper .custom-select-trigger { background-color: var(--surface); border-color: var(--success); color: var(--success); font-weight: 600; }
        
        .custom-options { position: absolute; top: 100%; left: 0; right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 0.375rem; margin-top: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; z-index: 50; max-height: 250px; overflow-y: auto; padding: 0.5rem; }
        .custom-options.open { display: block; }
        .option-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem; cursor: pointer; border-radius: 0.25rem; font-size: 0.9rem; color: var(--text-main); }
        .option-item:hover { background-color: var(--bg-body); }
        .dropdown-search { width: 100%; padding: 0.4rem; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 0.25rem; margin-bottom: 0.5rem; background: var(--input-bg); color: var(--text-main); outline:none; }

        .search-input-wrapper { position: relative; min-width: 160px; flex-grow: 1; }
        .search-input { width: 100%; padding: 0 0.75rem 0 2.2rem; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); }
        .search-icon { position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: var(--text-light); }
        
        .date-input-wrapper { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-light); }
        .date-input { padding: 0 0.6rem; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main); width: 100px; cursor: pointer; }

        .btn-group { display: flex; border: 1px solid var(--border); border-radius: 0.375rem; overflow: hidden; background: var(--input-bg); }
        .btn-group-item { padding: 0 1rem; font-size: 0.85rem; cursor: pointer; background: transparent; border: none; border-right: 1px solid var(--border); color: var(--text-light); transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; justify-content: center; }
        .btn-group-item:last-child { border-right: none; }
        .btn-group-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        .btn-group-item.active { background-color: var(--primary); color: white; }
        
        .toggle-filter { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-light); cursor: pointer; user-select: none; }

        /* Data Table */
        .table-wrapper { background: var(--surface); border-radius: 0.5rem; border: 1px solid var(--border); box-shadow: var(--shadow-sm); overflow: auto; flex: 1; min-height: 300px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.8rem; }
        thead { position: sticky; top: 0; z-index: 5; background-color: var(--bg-body); }
        th, td { padding: 0.6rem 1rem; white-space: nowrap; border-bottom: 1px solid var(--border); }
        th { text-align: left; font-weight: 600; color: var(--text-light); background-color: var(--bg-body); user-select: none; }
        th.th-sortable { cursor: pointer; }
        th.th-sortable:hover { background-color: var(--border); color: var(--text-main); }
        td { color: var(--text-main); vertical-align: middle; }
        .text-right { text-align: right; }
        .row-grouped { background-color: var(--group-row-bg); font-weight: 600; color: var(--group-row-text); }
        .val-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block; }
        .val-ok { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .val-no { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .sort-icon { margin-left: 0.5rem; opacity: 0.4; font-size: 0.85em; display: inline-block; vertical-align: middle;}
        .sort-icon.active { opacity: 1; color: var(--primary); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; flex-shrink: 0; }
        .stat-box { background: var(--surface); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; height: 300px; overflow: hidden; }
        .stat-box h4 { font-size: 0.85rem; font-weight: 600; color: var(--text-light); margin-bottom: 0.8rem; text-transform: uppercase; }
        .canvas-container { flex: 1; position: relative; min-height: 0; }
        .list-container { flex: 1; overflow-y: auto; padding-right: 0.5rem; }
        .stat-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .stat-list-val { font-weight: 600; color: var(--text-main); }
        .stat-list-label { color: var(--text-light); text-overflow: ellipsis; overflow: hidden; white-space: nowrap; max-width: 70%; }
        .legend-item { display: flex; align-items: center; font-size: 0.7rem; color: var(--text-light); width: 100%; margin-bottom: 2px; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; margin-right: 6px; flex-shrink: 0; }
        .custom-legend { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; overflow-y: auto; max-height: 80px; }

        /* Modals & Overlays */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(4px); opacity: 0; animation: fadeIn 0.2s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .modal-card { background: var(--surface); width: 100%; max-width: 480px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(0.95); animation: scaleUp 0.2s forwards; }
        .modal-card.modal-lg { max-width: 900px; }
        @keyframes scaleUp { to { transform: scale(1); } }
        .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; }
        .modal-body { padding: 1.25rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.75rem; background: var(--bg-body); border-radius: 0 0 12px 12px; flex-shrink: 0; }
        .loading-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 1rem; backdrop-filter: blur(3px); }
        .spinner { width: 48px; height: 48px; border: 5px solid var(--border); border-bottom-color: var(--primary); border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) { 
            .sidebar { position: fixed; height: 100%; left: -100%; box-shadow: 5px 0 15px rgba(0,0,0,0.1); } 
            .sidebar.mobile-open { left: 0; } 
            .user-type-badge, .brand span { display: none; }
            .kpi-container { grid-template-columns: 1fr 1fr; }
            .filters-row { flex-direction: column; align-items: stretch; }
            .stats-grid { grid-template-columns: 1fr; }
            .col-config-wrapper { display: block !important; width: 36px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 5. LÓGICA REACT -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const IconWrapper = ({ children, size=24, color="currentColor", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>
        );
        const Icons = {
            Moon: (p) => <IconWrapper {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconWrapper>,
            Sun: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconWrapper>,
            Bell: (p) => <IconWrapper {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></IconWrapper>,
            CloudDownload: (p) => <IconWrapper {...p}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m8 17 4 4 4-4"/></IconWrapper>,
            User: (p) => <IconWrapper {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconWrapper>,
            Menu: (p) => <IconWrapper {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconWrapper>,
            ChevronLeft: (p) => <IconWrapper {...p}><path d="m15 18-6-6 6-6"/></IconWrapper>,
            ChevronRight: (p) => <IconWrapper {...p}><path d="m9 18 6-6-6-6"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Eye: (p) => <IconWrapper {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconWrapper>,
            EyeOff: (p) => <IconWrapper {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconWrapper>,
            AlertOctagon: (p) => <IconWrapper {...p}><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>
        };

        const DownloadsModule = () => {
            const URL_MANIAGRO = "https://docs.google.com/spreadsheets/d/1IDhJ8E7h5d7ezknTK-BaJkF66ydHAy4zZAv4FLl9u0k/edit?usp=sharing";
            const CHART_COLORS = ['#204B42', '#10b981', '#f59e0b', '#3b82f6', '#64748b', '#ef4444', '#8b5cf6'];
            
            const GROUP_DIMS = [
                { key: 'DESTINO DESCARGA', label: 'Destino' },
                { key: 'FECHA PESADA', label: 'Fecha' },
                { key: 'ESTABLECIMIENTO', label: 'Establecimiento' },
                { key: 'LOTE', label: 'Lote' },
                { key: 'PRODUCTO', label: 'Producto' },
                { key: 'PRODUCTOR', label: 'Productor' },
                { key: 'CONTRATISTA', label: 'Contratista' },
                { key: 'TOLVA', label: 'Tolva' }
            ];

            // Initial State
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [displayUnit, setDisplayUnit] = useState('TON'); 
            const [filterDestType, setFilterDestType] = useState('ALL'); 
            const [groupByKeys, setGroupByKeys] = useState([]);
            const [hideLow, setHideLow] = useState(true);
            const [isQuickGroup, setIsQuickGroup] = useState(false);
            const [groupOptionsOpen, setGroupOptionsOpen] = useState(false);
            
            const [colConfig, setColConfig] = useState({
                'VALIDACION': { label: 'Validación', visible: false, dimensionKey: 'VALIDACION' },
                'STATUS': { label: 'Estado', visible: true, width: '50px' },
                'FECHA PESADA': { label: 'Fecha', visible: true, dimensionKey: 'FECHA PESADA' },
                'HORA PESADA': { label: 'Hora', visible: true, dimensionKey: 'HORA PESADA' },
                'PRODUCTOR': { label: 'Productor', visible: false, dimensionKey: 'PRODUCTOR' },
                'CONTRATISTA': { label: 'Contratista', visible: true, dimensionKey: 'CONTRATISTA' },
                'ESTABLECIMIENTO': { label: 'Establecimiento', visible: true, dimensionKey: 'ESTABLECIMIENTO' },
                'LOTE': { label: 'Lote', visible: true, dimensionKey: 'LOTE' },
                'PRODUCTO': { label: 'Producto', visible: true, dimensionKey: 'PRODUCTO' },
                'DESTINO DESCARGA': { label: 'Destino', visible: true, dimensionKey: 'DESTINO DESCARGA' },
                'CARTA DE PORTE': { label: 'Carta Porte', visible: false, dimensionKey: 'CARTA DE PORTE' },
                'PESO_NUM': { label: 'Kg Húmedo', visible: true, align: 'right' },
                'TOLVA': { label: 'Tolva', visible: true, dimensionKey: 'TOLVA' },
                'ACTIONS': { label: '', visible: true, width: '1%' },
                'UBICACION': { label: 'Ubic.', visible: true, align: 'center', width: '1%' }
            });

            const [filters, setFilters] = useState({
                est: [], lote: [], prod: [], productor: [], contratista: [], tolva: [], search: '', dateFrom: null, dateTo: null
            });
            const [showMap, setShowMap] = useState(false);
            const [importUrl, setImportUrl] = useState(URL_MANIAGRO);
            const [showImportModal, setShowImportModal] = useState(false);
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });

            const chartEstRef = useRef(null);
            const chartProdRef = useRef(null);
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const chartInstances = useRef({});
            const dateFromRef = useRef(null);
            const dateToRef = useRef(null);
            const fpFromInstance = useRef(null);
            const fpToInstance = useRef(null);

            useEffect(() => { loadData(importUrl); }, [importUrl]);

            const loadData = async (url) => {
                setLoading(true);
                try {
                    const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
                    const csvUrl = match ? `https://docs.google.com/spreadsheets/d/${match[1]}/export?format=csv` : url;
                    const res = await fetch(csvUrl);
                    const text = await res.text();
                    const parsed = parseCSV(text);
                    setData(parsed);
                    
                    const dates = parsed.map(d => d.DATE_OBJ).filter(Boolean);
                    if (dates.length > 0) {
                        const maxDate = new Date(Math.max.apply(null, dates));
                        setFilters(prev => ({...prev, dateFrom: maxDate, dateTo: maxDate}));
                        if(fpFromInstance.current) fpFromInstance.current.setDate(maxDate);
                        if(fpToInstance.current) fpToInstance.current.setDate(maxDate);
                    }
                } catch (e) {
                    console.error("Error cargando CSV", e);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (dateFromRef.current) {
                    fpFromInstance.current = flatpickr(dateFromRef.current, { 
                        dateFormat: "d/m/Y", 
                        onChange: (sel) => setFilters(f => ({...f, dateFrom: sel[0]})) 
                    });
                }
                if (dateToRef.current) {
                    fpToInstance.current = flatpickr(dateToRef.current, { 
                        dateFormat: "d/m/Y", 
                        onChange: (sel) => setFilters(f => ({...f, dateTo: sel[0]})) 
                    });
                }
            }, []);

            const parseCSV = (csv) => {
                const lines = csv.split('\n');
                if(lines.length < 2) return [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                return lines.slice(1).map((line, idx) => {
                    if(!line.trim()) return null;
                    const vals = parseCSVLine(line);
                    const row = { id: idx };
                    headers.forEach((h, i) => row[h] = vals[i]?.trim().replace(/^"|"$/g, '') || '');
                    row.PESO_NUM = parseFloat(row['PESO HUMEDO Kg']) || 0;
                    row.DATE_OBJ = parseDateStrict(row['FECHA PESADA']);
                    row.LAT_NUM = parseFloat(row['LATITUD']) || 0;
                    row.LNG_NUM = parseFloat(row['LONGITUD']) || 0;
                    const tipo = (row['TIPO'] || '').toUpperCase();
                    row.IS_DEFECT = tipo.includes('DEFECTUOSA');
                    row.IS_OVERWEIGHT = row.PESO_NUM > 30000;
                    row.IS_AUTO = tipo.includes('AUT') || tipo.includes('MODIFICADA');
                    row.IS_VALID = (row['VALIZACION'] && row['VALIZACION'].toUpperCase() === 'TRUE');
                    return row;
                }).filter(Boolean);
            };

            const parseCSVLine = (text) => {
                let p = '', row = [''], i = 0, r = 0, s = !0, l;
                for (l of text) {
                    if ('"' === l) { if (s && l === p) row[r] += l; s = !s; }
                    else if (',' === l && s) l = row[++r] = '';
                    else row[r] += l; p = l;
                }
                return row;
            };

            const parseDateStrict = (str) => {
                if(!str) return null;
                const parts = str.replace(/-/g, '/').split('/');
                if (parts.length !== 3) return null;
                let d, m, y;
                if(parts[0].length === 4) { y=+parts[0]; m=+parts[1]-1; d=+parts[2]; }
                else { d=+parts[0]; m=+parts[1]-1; y=+parts[2]; }
                return new Date(y, m, d);
            };

            const filteredData = useMemo(() => {
                return data.filter(r => {
                    if (hideLow && r.PESO_NUM < 100) return false;
                    
                    if (filters.dateFrom && r.DATE_OBJ) {
                        const d = new Date(r.DATE_OBJ); d.setHours(0,0,0,0);
                        const f = new Date(filters.dateFrom); f.setHours(0,0,0,0);
                        if (d < f) return false;
                    }
                    if (filters.dateTo && r.DATE_OBJ) {
                        const d = new Date(r.DATE_OBJ); d.setHours(0,0,0,0);
                        const f = new Date(filters.dateTo); f.setHours(23,59,59,999);
                        if (d > f) return false;
                    }

                    if (filters.est.length && !filters.est.includes(r['ESTABLECIMIENTO'])) return false;
                    if (filters.lote.length && !filters.lote.includes(r['LOTE'])) return false;
                    if (filters.prod.length && !filters.prod.includes(r['PRODUCTO'])) return false;
                    if (filters.productor.length && !filters.productor.includes(r['PRODUCTOR'])) return false;
                    if (filters.tolva.length && !filters.tolva.includes(r['TOLVA'])) return false;
                    if (filters.contratista.length && !filters.contratista.includes(r['CONTRATISTA'])) return false;
                    if (filters.search && !r['DESTINO DESCARGA'].toLowerCase().includes(filters.search.toLowerCase())) return false;

                    const dest = (r['DESTINO DESCARGA'] || '').toUpperCase();
                    const isSilo = dest.includes('BOLSA') || dest.includes('SILO') || /^\d{2}-[A-Z]/.test(dest);
                    if (filterDestType === 'SILO' && !isSilo) return false;
                    if (filterDestType === 'TRUCK' && isSilo) return false;

                    return true;
                });
            }, [data, filters, hideLow, filterDestType]);

            const displayData = useMemo(() => {
                let result = [];
                if (groupByKeys.length === 0) {
                    result = [...filteredData];
                } else {
                    const groups = {};
                    filteredData.forEach(r => {
                        const key = groupByKeys.map(k => r[k] || '-').join('|');
                        if (!groups[key]) {
                            groups[key] = { isGroup: true, count: 0, PESO_NUM: 0, items: [], ...Object.fromEntries(groupByKeys.map(k => [k, r[k]])) };
                        }
                        groups[key].PESO_NUM += r.PESO_NUM;
                        groups[key].count++;
                        groups[key].items.push(r);
                    });
                    result = Object.values(groups);
                }
                
                if (sortConfig.key) {
                    result.sort((a,b) => {
                        let valA = a[sortConfig.key];
                        let valB = b[sortConfig.key];
                        if (sortConfig.key.includes('FECHA')) {
                            valA = a.DATE_OBJ ? a.DATE_OBJ.getTime() : 0;
                            valB = b.DATE_OBJ ? b.DATE_OBJ.getTime() : 0;
                        } else if(typeof valA === 'string') {
                            valA = valA.toLowerCase(); valB = valB ? valB.toLowerCase() : '';
                        }
                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return result;
            }, [filteredData, groupByKeys, sortConfig]);

            // Función de agregación correcta para los gráficos (Top 15 ordenado)
            const getAggregatedData = (data, key) => {
                const map = {};
                data.forEach(r => {
                    const k = r[key] || 'Sin Datos';
                    map[k] = (map[k] || 0) + r.PESO_NUM;
                });
                // Convertir a array y ordenar descendente por valor
                return Object.entries(map)
                    .map(([label, value]) => ({ label, value }))
                    .sort((a, b) => b.value - a.value);
            };

            useEffect(() => {
                if (!window.Chart || loading) return;
                const renderChart = (ref, type, dataArray, label) => {
                    if (chartInstances.current[ref.id]) chartInstances.current[ref.id].destroy();
                    // Tomar solo el top 15 para que no se sature
                    const topData = dataArray.slice(0, 15);
                    const labels = topData.map(d => d.label);
                    const values = topData.map(d => displayUnit === 'TON' ? d.value/1000 : d.value);
                    
                    chartInstances.current[ref.id] = new Chart(ref, {
                        type: type,
                        data: { labels, datasets: [{ label, data: values, backgroundColor: CHART_COLORS, borderWidth: 1 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut', position: 'right' } } }
                    });
                };

                const estData = getAggregatedData(filteredData, 'ESTABLECIMIENTO');
                const prodData = getAggregatedData(filteredData, 'PRODUCTO');

                if (chartEstRef.current) renderChart(chartEstRef.current, 'bar', estData, 'Totales');
                if (chartProdRef.current) renderChart(chartProdRef.current, 'doughnut', prodData, 'Totales');
            }, [filteredData, displayUnit, loading]);

            useEffect(() => {
                if (showMap && window.google && !mapInstance.current) {
                    mapInstance.current = new window.google.maps.Map(mapRef.current, { center: { lat: -32.05, lng: -62.69 }, zoom: 10, mapTypeId: 'satellite' });
                }
                if (showMap && mapInstance.current) {
                    filteredData.forEach(r => {
                        if (r.LAT_NUM && r.LNG_NUM) {
                            new window.google.maps.Marker({ position: { lat: r.LAT_NUM, lng: r.LNG_NUM }, map: mapInstance.current, title: r.ESTABLECIMIENTO });
                        }
                    });
                }
            }, [showMap, filteredData]);

            const toggleQuickGroup = () => {
                if (isQuickGroup) {
                    setGroupByKeys([]);
                    setIsQuickGroup(false);
                } else {
                    const keys = ['FECHA PESADA', 'ESTABLECIMIENTO', 'LOTE', 'PRODUCTO', 'DESTINO DESCARGA', 'CONTRATISTA'];
                    setGroupByKeys(keys);
                    setIsQuickGroup(true);
                }
            };

            const toggleGroupKey = (key) => {
                setGroupByKeys(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
            };

            const kpis = useMemo(() => {
                let truckC = 0, truckW = 0, siloC = 0, siloW = 0;
                filteredData.forEach(r => {
                    const dest = (r['DESTINO DESCARGA'] || '').toUpperCase();
                    const isSilo = dest.includes('BOLSA') || dest.includes('SILO') || /^\d{2}-[A-Z]/.test(dest);
                    if (isSilo) { siloC++; siloW += r.PESO_NUM; } else { truckC++; truckW += r.PESO_NUM; }
                });
                return { truckC, truckW, siloC, siloW };
            }, [filteredData]);

            const getUniqueOptions = (key) => [...new Set(data.map(r => r[key]).filter(Boolean))].sort();
            const formatWeight = (val) => displayUnit === 'TON' ? (val/1000).toLocaleString('es-AR', {maximumFractionDigits: 1}) + ' t' : val.toLocaleString('es-AR', {maximumFractionDigits: 0}) + ' kg';
            
            const handleFilterChange = (key, val, checked) => {
                setFilters(prev => {
                    const current = prev[key];
                    const next = checked ? [...current, val] : current.filter(item => item !== val);
                    return { ...prev, [key]: next };
                });
            };

            const handleSort = (key) => {
                setSortConfig(prev => ({ key, direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc' }));
            };

            const CustomSelect = ({ label, options, selected, onChange }) => {
                const [isOpen, setIsOpen] = useState(false);
                const [search, setSearch] = useState('');
                const filteredOpts = options.filter(o => o.toLowerCase().includes(search.toLowerCase()));
                return (
                    <div className="custom-select-wrapper">
                        <div className="custom-select-trigger" onClick={() => setIsOpen(!isOpen)}>
                            <span>{label} {selected.length > 0 && `(${selected.length})`}</span>
                            <i className="ph ph-caret-down"></i>
                        </div>
                        {isOpen && (
                            <div className="custom-options open">
                                <input type="text" className="dropdown-search" placeholder="Buscar..." onClick={e=>e.stopPropagation()} onChange={e=>setSearch(e.target.value)} />
                                {filteredOpts.map(opt => (
                                    <div key={opt} className="option-item" onClick={(e) => { e.stopPropagation(); onChange(opt, !selected.includes(opt)); }}>
                                        <input type="checkbox" checked={selected.includes(opt)} readOnly /> {opt}
                                    </div>
                                ))}
                            </div>
                        )}
                        {isOpen && <div style={{position:'fixed', inset:0, zIndex:40}} onClick={() => setIsOpen(false)}></div>}
                    </div>
                );
            };

            const ColConfigDropdown = () => {
                const [isOpen, setIsOpen] = useState(false);
                return (
                    <div className="custom-select-wrapper col-config-wrapper" style={{width:'auto'}}>
                        <div className="custom-select-trigger btn-square" onClick={() => setIsOpen(!isOpen)} title="Configurar Columnas">
                            <i className="ph ph-gear"></i>
                        </div>
                        {isOpen && (
                            <div className="custom-options open" style={{right:0, left:'auto', width:200}}>
                                {Object.keys(colConfig).map(key => (
                                    <div key={key} className="option-item" onClick={(e) => {
                                        e.stopPropagation();
                                        setColConfig(prev => ({...prev, [key]: {...prev[key], visible: !prev[key].visible}}));
                                    }}>
                                        <input type="checkbox" checked={colConfig[key].visible} readOnly /> {colConfig[key].label || key}
                                    </div>
                                ))}
                            </div>
                        )}
                        {isOpen && <div style={{position:'fixed', inset:0, zIndex:40}} onClick={() => setIsOpen(false)}></div>}
                    </div>
                );
            };

            return (
                <div className="module-container">
                    {loading && <div className="loading-overlay"><div className="spinner"></div><div className="loading-text">Procesando...</div></div>}
                    
                    <div className="dashboard-content">
                        {/* KPIs */}
                        <section className="kpi-container">
                            <div className="kpi-card" title="Total de camiones descargados">
                                <div className="kpi-label"><i className="ph ph-truck"></i> Camiones</div>
                                <div className="kpi-value">{kpis.truckC}</div>
                                <div style={{fontSize:'0.75rem', color:'var(--text-light)'}}>Viajes</div>
                            </div>
                            <div className="kpi-card clickable-unit" title="Clic para cambiar unidad (Kg/Ton)" onClick={() => setDisplayUnit(prev => prev==='TON'?'KG':'TON')}>
                                <div className="kpi-header-row">
                                    <div className="kpi-label">Camiones</div>
                                    <div className="unit-toggle-pill">{displayUnit} <i className="ph ph-arrows-left-right"></i></div>
                                </div>
                                <div className="kpi-value">{formatWeight(kpis.truckW).replace(' t','').replace(' kg','')}</div>
                                <div style={{fontSize:'0.75rem', color:'var(--text-light)'}}>Húmedo</div>
                            </div>
                            <div className="kpi-card" title="Total de cargas a silo bolsa">
                                <div className="kpi-label"><i className="ph ph-cylinder" style={{transform: 'rotate(90deg)'}}></i> Silos</div>
                                <div className="kpi-value">{kpis.siloC}</div>
                                <div style={{fontSize:'0.75rem', color:'var(--text-light)'}}>Cargas</div>
                            </div>
                            <div className="kpi-card clickable-unit" title="Clic para cambiar unidad (Kg/Ton)" onClick={() => setDisplayUnit(prev => prev==='TON'?'KG':'TON')}>
                                <div className="kpi-header-row">
                                    <div className="kpi-label">Silos</div>
                                    <div className="unit-toggle-pill">{displayUnit} <i className="ph ph-arrows-left-right"></i></div>
                                </div>
                                <div className="kpi-value">{formatWeight(kpis.siloW).replace(' t','').replace(' kg','')}</div>
                                <div style={{fontSize:'0.75rem', color:'var(--text-light)'}}>Húmedo</div>
                            </div>
                        </section>

                        {/* FILTROS */}
                        <section className="controls-container">
                            <div className="filters-row">
                                <div className="date-input-wrapper">
                                    <span>Desde:</span> <input type="text" ref={dateFromRef} className="date-input" placeholder="DD/MM/AAAA" />
                                </div>
                                <div className="date-input-wrapper">
                                    <span>Hasta:</span> <input type="text" ref={dateToRef} className="date-input" placeholder="DD/MM/AAAA" />
                                </div>
                                <button className="btn-std btn-outline" title="Ver descargas de hoy" onClick={() => {
                                    const today = new Date();
                                    if(fpFromInstance.current) fpFromInstance.current.setDate(today);
                                    if(fpToInstance.current) fpToInstance.current.setDate(today);
                                    setFilters(f => ({...f, dateFrom: today, dateTo: today}));
                                }}>Hoy</button>

                                <CustomSelect label="Productor" options={getUniqueOptions('PRODUCTOR')} selected={filters.productor} onChange={(val, c) => handleFilterChange('productor', val, c)} />
                                <CustomSelect label="Establecimiento" options={getUniqueOptions('ESTABLECIMIENTO')} selected={filters.est} onChange={(val, c) => handleFilterChange('est', val, c)} />
                                <CustomSelect label="Lote" options={getUniqueOptions('LOTE')} selected={filters.lote} onChange={(val, c) => handleFilterChange('lote', val, c)} />
                                <CustomSelect label="Contratista" options={getUniqueOptions('CONTRATISTA')} selected={filters.contratista} onChange={(val, c) => handleFilterChange('contratista', val, c)} />
                                <CustomSelect label="Tolva" options={getUniqueOptions('TOLVA')} selected={filters.tolva} onChange={(val, c) => handleFilterChange('tolva', val, c)} />
                                <CustomSelect label="Producto" options={getUniqueOptions('PRODUCTO')} selected={filters.prod} onChange={(val, c) => handleFilterChange('prod', val, c)} />
                                
                                <div className="search-input-wrapper">
                                    <i className="ph ph-magnifying-glass search-icon"></i>
                                    <input type="text" className="search-input" placeholder="Buscar Destino..." onChange={e => setFilters({...filters, search: e.target.value})} />
                                </div>

                                <div className="btn-group">
                                    <button className={`btn-group-item ${filterDestType==='ALL'?'active':''}`} onClick={() => setFilterDestType('ALL')} title="Ver Todo">Todos</button>
                                    <button className={`btn-group-item ${filterDestType==='TRUCK'?'active':''}`} onClick={() => setFilterDestType('TRUCK')} title="Solo Camiones"><i className="ph ph-truck"></i></button>
                                    <button className={`btn-group-item ${filterDestType==='SILO'?'active':''}`} onClick={() => setFilterDestType('SILO')} title="Solo Silos"><i className="ph ph-cylinder" style={{transform:'rotate(90deg)'}}></i></button>
                                </div>

                                <label className="toggle-filter" title="Excluir descargas menores a 100kg">
                                    <input type="checkbox" checked={hideLow} onChange={e => setHideLow(e.target.checked)} /> Ocultar &lt; 100kg
                                </label>
                            </div>
                            
                            <div className="filters-row" style={{justifyContent: 'space-between', borderTop: '1px solid var(--border)', paddingTop: '0.75rem'}}>
                                <div style={{display:'flex', gap:'0.5rem', alignItems:'center'}}>
                                    <span style={{fontSize:'0.8rem', fontWeight:600, color:'var(--text-light)'}}>AGRUPAR:</span>
                                    
                                    <div className="custom-select-wrapper group-by-wrapper">
                                        <div className="custom-select-trigger" onClick={() => setGroupOptionsOpen(!groupOptionsOpen)} style={groupByKeys.length > 0 ? {backgroundColor:'var(--group-active-bg)', borderColor:'var(--group-active-border)', color:'var(--group-active-text)'} : {}}>
                                            <span>{groupByKeys.length > 0 ? `${groupByKeys.length} Dimensión(es)` : '(Sin Agrupar)'}</span>
                                            <i className="ph ph-stack"></i>
                                        </div>
                                        {groupOptionsOpen && (
                                            <div className="custom-options open">
                                                {GROUP_DIMS.map(dim => (
                                                    <div key={dim.key} className="option-item" onClick={(e) => { e.stopPropagation(); toggleGroupKey(dim.key); }}>
                                                        <input type="checkbox" checked={groupByKeys.includes(dim.key)} readOnly /> {dim.label}
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {groupOptionsOpen && <div style={{position:'fixed', inset:0, zIndex:40}} onClick={() => setGroupOptionsOpen(false)}></div>}
                                    </div>

                                    <button className={`btn-std btn-flash ${isQuickGroup ? 'active' : ''}`} onClick={toggleQuickGroup} title="Agrupamiento rápido por destinos y lotes">
                                        <i className={`ph ${isQuickGroup ? 'ph-list-dashes' : 'ph-stack-plus'}`}></i> {isQuickGroup ? 'Desagrupar' : 'Agrupar Destinos'}
                                    </button>

                                    <button className="btn-square btn-outline" title="Limpiar todos los filtros" style={{borderColor: 'var(--danger)', color: 'var(--danger)'}} onClick={() => { setFilters({est:[],lote:[],prod:[],productor:[],contratista:[],tolva:[],search:'',dateFrom:null,dateTo:null}); setGroupByKeys([]); setIsQuickGroup(false); setHideLow(false); setDisplayUnit('TON'); }}>
                                        <i className="ph ph-trash"></i>
                                    </button>
                                </div>
                                
                                <div style={{display:'flex', gap:'0.5rem'}}>
                                    <button className="btn-square btn-outline" onClick={() => setShowImportModal(true)} title="Importar Datos"><i className="ph ph-cloud-arrow-down"></i></button>
                                    <button className="btn-std btn-primary" onClick={() => setShowMap(true)} title="Ver mapa con todas las descargas"><i className="ph ph-map-trifold"></i> Ver Mapa Global</button>
                                    <ColConfigDropdown />
                                </div>
                            </div>
                        </section>

                        {/* TABLA */}
                        <section className="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th style={{width:30}}></th>
                                        {Object.keys(colConfig).map(key => {
                                            const conf = colConfig[key];
                                            let show = conf.visible;
                                            if(groupByKeys.length > 0) {
                                                if(!['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key) && !groupByKeys.includes(conf.dimensionKey)) show = false;
                                            }
                                            if(!show) return null;
                                            
                                            return (
                                                <th key={key} className={key==='ACTIONS'||key==='UBICACION'?'col-tight':'th-sortable'} style={{width:conf.width, textAlign:conf.align}} onClick={() => handleSort(key)}>
                                                    {conf.label} 
                                                    {!['ACTIONS', 'UBICACION'].includes(key) && <i className={`ph ${sortConfig.key === key ? (sortConfig.direction==='asc'?'ph-caret-up':'ph-caret-down') : 'ph-caret-up-down'} sort-icon ${sortConfig.key===key?'active':''}`}></i>}
                                                </th>
                                            );
                                        })}
                                    </tr>
                                </thead>
                                <tbody>
                                    {displayData.map((row, i) => (
                                        <tr key={i} className={row.isGroup ? 'row-grouped' : ''}>
                                            <td><input type="checkbox"/></td>
                                            {Object.keys(colConfig).map(key => {
                                                const conf = colConfig[key];
                                                let show = conf.visible;
                                                if(groupByKeys.length > 0) {
                                                    if(!['STATUS', 'PESO_NUM', 'ACTIONS', 'UBICACION'].includes(key) && !groupByKeys.includes(conf.dimensionKey)) show = false;
                                                }
                                                if(!show) return null;

                                                let content;
                                                if(key === 'STATUS') {
                                                    if (row.isGroup) content = <span style={{background:'#dbeafe', padding:'2px 6px', borderRadius:'4px', fontSize:'0.7rem', color:'#1e40af', fontWeight:'bold'}}>{row.count} Regs</span>;
                                                    else content = row.IS_DEFECT ? <i className="ph ph-warning-diamond" style={{color:'var(--danger)', fontSize:'1.2rem'}} title="Carga Defectuosa"></i> : row.IS_OVERWEIGHT ? <i className="ph ph-warning" style={{color:'var(--warning)', fontSize:'1.2rem'}} title="Sobrepeso"></i> : <i className="ph ph-check-circle" style={{color:'var(--success)', fontSize:'1.2rem'}} title="Validada"></i>;
                                                } else if (key === 'VALIDACION') {
                                                    content = row.isGroup ? '-' : <span className={`val-badge ${row.IS_VALID?'val-ok':'val-no'}`}>{row.IS_VALID?'Validada':'No Val.'}</span>;
                                                } else if (key === 'ACTIONS') {
                                                    content = !row.isGroup ? <button className="btn-icon" title="Editar"><i className="ph ph-pencil-simple"></i></button> : null;
                                                } else if (key === 'UBICACION') {
                                                    content = (row.LAT_NUM || row.isGroup) ? <div className="map-trigger" onClick={() => setShowMap(true)} title="Ver en mapa"><i className="ph ph-map-pin"></i></div> : null;
                                                } else if (key === 'PESO_NUM') {
                                                    content = <b>{formatWeight(row.PESO_NUM).replace(' t','').replace(' kg','')}</b>;
                                                } else {
                                                    content = row.isGroup ? (groupByKeys.includes(conf.dimensionKey) ? <strong>{row[key]}</strong> : '-') : row[key];
                                                }

                                                return <td key={key} className={key==='ACTIONS'||key==='UBICACION'?'col-tight':''} style={{textAlign:conf.align}}>{content}</td>;
                                            })}
                                        </tr>
                                    ))}
                                    {displayData.length === 0 && <tr><td colSpan="20" style={{textAlign:'center', padding:'2rem'}}>Sin datos</td></tr>}
                                </tbody>
                            </table>
                        </section>

                        {/* CHARTS */}
                        <section className="stats-grid">
                            <div className="stat-box">
                                <h4>Totales por Establecimiento</h4>
                                <div className="canvas-container"><canvas ref={chartEstRef}></canvas></div>
                            </div>
                            <div className="stat-box">
                                <h4>Totales por Cultivo</h4>
                                <div className="canvas-container"><canvas ref={chartProdRef}></canvas></div>
                            </div>
                            <div className="stat-box">
                                <h4>Ranking Tolvas</h4>
                                <div className="list-container">
                                    {getAggregatedData(filteredData, 'TOLVA').slice(0,8).map((d,i) => (
                                        <div key={i} className="stat-list-item">
                                            <span className="stat-list-label" title={d.label}>{d.label}</span>
                                            <span className="stat-list-val">{formatWeight(d.value)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="stat-box">
                                <h4>Ranking Contratistas</h4>
                                <div className="list-container">
                                    {getAggregatedData(filteredData, 'CONTRATISTA').slice(0,8).map((d,i) => (
                                        <div key={i} className="stat-list-item">
                                            <span className="stat-list-label" title={d.label}>{d.label}</span>
                                            <span className="stat-list-val">{formatWeight(d.value)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>
                    </div>

                    {/* MODALES INTERNOS */}
                    {showMap && (
                        <div className="modal-overlay" style={{opacity:1, pointerEvents:'all'}}>
                            <div className="modal-card modal-lg">
                                <div className="modal-header"><h3>Mapa Global</h3><button className="btn-square btn-outline" onClick={()=>setShowMap(false)}><i className="ph ph-x"></i></button></div>
                                <div style={{flex:1}} ref={mapRef}></div>
                            </div>
                        </div>
                    )}
                    {showImportModal && (
                        <div className="modal-overlay" style={{opacity:1, pointerEvents:'all'}}>
                            <div className="modal-card">
                                <div className="modal-header"><h3>Importar Datos</h3><button className="btn-square btn-outline" onClick={()=>setShowImportModal(false)}><i className="ph ph-x"></i></button></div>
                                <div className="modal-body">
                                    <input type="text" className="search-input" value={importUrl} onChange={e=>setImportUrl(e.target.value)} />
                                    <div className="btn-group">
                                        <button className="btn-group-item active">Maniagro</button>
                                        <button className="btn-group-item">AGD</button>
                                    </div>
                                </div>
                                <div className="modal-footer"><button className="btn-std btn-primary" onClick={()=>setShowImportModal(false)}>Cargar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const EmptyModule = ({ title }) => (
            <div className="module-content">
                <div className="empty-state-icon"><Icons.CloudDownload size={64} /></div>
                <h2 style={{fontWeight: 400, color: 'var(--text-main)'}}>{title}</h2>
                <p style={{fontSize: '0.9rem', marginTop: '0.5rem'}}>Módulo en construcción</p>
            </div>
        );

        const ProfileModal = ({ isOpen, onClose, user, onSave }) => {
            if (!isOpen) return null;
            const [formData, setFormData] = useState({ ...user });
            const [showPass, setShowPass] = useState({ old: false, new: false, confirm: false });
            return (
                <div className="modal-overlay" onClick={onClose} style={{opacity:1, pointerEvents:'all'}}>
                    <div className="modal-card" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <h3>Mi Perfil</h3>
                            <button className="btn-icon" onClick={onClose}><Icons.X size={20}/></button>
                        </div>
                        <div className="modal-body">
                            <div className="form-group"><label className="form-label">Nombre</label><input value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="form-input" /></div>
                            <div className="form-group"><label className="form-label">Apellido</label><input value={formData.lastname} onChange={e => setFormData({...formData, lastname: e.target.value})} className="form-input" /></div>
                            <div className="form-group"><label className="form-label">Email</label><input value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} className="form-input" /></div>
                            <div className="form-group"><label className="form-label">Teléfono</label><input value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} className="form-input" /></div>
                            <div className="section-title">Cambiar Contraseña</div>
                            <div className="form-group"><label className="form-label">Contraseña Anterior</label><div className="password-wrapper"><input type={showPass.old ? "text" : "password"} className="form-input" style={{paddingRight: '2.5rem'}} placeholder="Clave actual" /><button className="toggle-pass-btn" onClick={() => setShowPass({...showPass, old: !showPass.old})}>{showPass.old ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>}</button></div></div>
                            <div className="form-group"><label className="form-label">Nueva Contraseña</label><div className="password-wrapper"><input type={showPass.new ? "text" : "password"} className="form-input" style={{paddingRight: '2.5rem'}} placeholder="Nueva clave" /><button className="toggle-pass-btn" onClick={() => setShowPass({...showPass, new: !showPass.new})}>{showPass.new ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>}</button></div></div>
                        </div>
                        <div className="modal-footer"><button className="btn-std btn-outline" onClick={onClose}>Cancelar</button><button className="btn-std btn-primary" onClick={() => onSave(formData)}>Guardar</button></div>
                    </div>
                </div>
            );
        };

        const Header = ({ darkMode, toggleDarkMode, toggleSidebar, user, onEditProfile }) => {
            const [showNotif, setShowNotif] = useState(false);
            const alerts = [
                { type: 'Modificación', color: 'var(--info)', msg: 'El tolvero modificó humedad.', time: '14:30' },
                { type: 'Sobrepeso', color: 'var(--warning)', msg: 'Exceso detectado.', time: '12:15' },
                { type: 'Falla', color: 'var(--danger)', msg: 'Sensor fallando.', time: '10:45' }
            ];
            return (
                <header>
                    <div className="brand">
                        <button className="nav-icon-btn" onClick={toggleSidebar} style={{marginRight:'1rem'}}><Icons.Menu size={24}/></button>
                        <div className="logo-box">AG</div>
                        <h1>Descargas <span>| AGDP</span> <span className="version-badge">v4.23</span></h1>
                    </div>
                    <div className="header-actions">
                        <div className="user-type-badge">Productor: <strong>2218PH</strong></div>
                        <button className="nav-icon-btn" onClick={toggleDarkMode}>{darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}</button>
                        <div style={{position:'relative'}}>
                            <button className="nav-icon-btn" onClick={() => setShowNotif(!showNotif)}><Icons.Bell size={20}/> <span className="notif-dot"></span></button>
                            {showNotif && (
                                <div className="dropdown">
                                    <div className="dd-header">Alertas Recientes</div>
                                    {alerts.map((a,i) => (
                                        <div key={i} className="dd-item">
                                            <Icons.AlertOctagon size={14} color={a.color} style={{marginTop:2}}/>
                                            <div><div style={{fontWeight:600}}>{a.type}</div><div style={{fontSize:'0.8rem'}}>{a.msg}</div></div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <button className="nav-icon-btn"><Icons.CloudDownload size={20}/></button>
                        <div className="user-profile" onClick={onEditProfile}><Icons.User size={20}/> <span>{user.name}</span></div>
                    </div>
                </header>
            );
        };

        const Sidebar = ({ activeTab, setActiveTab, collapsed, toggleCollapse }) => {
            const items = [
                { id: 'descargas', label: 'Descargas' },
                { id: 'tolvas', label: 'Tolvas' },
                { id: 'establecimientos', label: 'Establecimientos' },
            ];
            return (
                <div className={`sidebar ${collapsed ? 'collapsed' : ''}`}>
                    {items.map(i => (
                        <div key={i.id} className={`sidebar-item ${activeTab===i.id ? 'active' : ''}`} onClick={() => setActiveTab(i.id)}>
                             <span>{i.label}</span>
                        </div>
                    ))}
                    <div className="sidebar-footer">
                        <button className="nav-icon-btn" style={{color:'var(--text-light)', marginLeft:'auto'}} onClick={toggleCollapse}>
                            {collapsed ? <Icons.ChevronRight/> : <Icons.ChevronLeft/>}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [activeTab, setActiveTab] = useState('descargas');
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [user, setUser] = useState({ name: 'Martin', lastname: 'Usuario', email: 'martin@agdp.com', phone: '1122334455' });
            const [isProfileOpen, setProfileOpen] = useState(false);

            useEffect(() => { document.body.className = darkMode ? 'dark-mode' : ''; }, [darkMode]);

            return (
                <div className="app-container">
                    <Header darkMode={darkMode} toggleDarkMode={() => setDarkMode(!darkMode)} toggleSidebar={() => setSidebarCollapsed(false)} user={user} onEditProfile={() => setProfileOpen(true)} />
                    <div className="main-layout">
                        <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} collapsed={sidebarCollapsed} toggleCollapse={() => setSidebarCollapsed(!sidebarCollapsed)} />
                        <main style={{flex:1, overflow:'hidden', display:'flex', flexDirection:'column'}}>
                            {activeTab === 'descargas' ? <DownloadsModule /> : <EmptyModule title={activeTab.charAt(0).toUpperCase() + activeTab.slice(1)} />}
                        </main>
                    </div>
                    <ProfileModal isOpen={isProfileOpen} onClose={() => setProfileOpen(false)} user={user} onSave={(data) => { setUser(data); setProfileOpen(false); }} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
